package cn.com.cdboost.charge.customer.dubbo.impl;

import cn.com.cdboost.charge.base.exception.BusinessException;
import cn.com.cdboost.charge.base.util.DateUtil;
import cn.com.cdboost.charge.base.util.MathUtil;
import cn.com.cdboost.charge.base.util.UuidUtil;
import cn.com.cdboost.charge.base.vo.PageData;
import cn.com.cdboost.charge.customer.constant.CustomerConstant;
import cn.com.cdboost.charge.customer.dao.CustomerPayCardMapper;
import cn.com.cdboost.charge.customer.dao.DeviceLogMapper;
import cn.com.cdboost.charge.customer.dao.DeviceSignalMapper;
import cn.com.cdboost.charge.customer.dao.DeviceUseDetailedMapper;
import cn.com.cdboost.charge.customer.dto.info.MessageListDto;
import cn.com.cdboost.charge.customer.dto.param.MessageListQueryDto;
import cn.com.cdboost.charge.customer.dubbo.CustomerService;
import cn.com.cdboost.charge.customer.model.*;
import cn.com.cdboost.charge.customer.service.*;
import cn.com.cdboost.charge.customer.vo.info.*;
import cn.com.cdboost.charge.customer.vo.param.*;
import cn.com.cdboost.charge.merchant.constant.SchemeConstant;
import cn.com.cdboost.charge.merchant.dubbo.DeviceService;
import cn.com.cdboost.charge.merchant.dubbo.IcCardService;
import cn.com.cdboost.charge.merchant.dubbo.PaySchemeService;
import cn.com.cdboost.charge.merchant.dubbo.ProjectService;
import cn.com.cdboost.charge.merchant.vo.info.DeviceDetailVo;
import cn.com.cdboost.charge.merchant.vo.info.DeviceVo;
import cn.com.cdboost.charge.merchant.vo.info.PaySchemeVo;
import cn.com.cdboost.charge.merchant.vo.info.ProjectVo;
import cn.com.cdboost.charge.payment.dubbo.AlipayService;
import cn.com.cdboost.charge.payment.dubbo.WechatService;
import cn.com.cdboost.charge.payment.vo.param.TradeCreateParam;
import cn.com.cdboost.charge.payment.vo.param.WxUnifiedOrderParam;
import cn.com.cdboost.charge.settlement.constant.AccountDictEnum;
import cn.com.cdboost.charge.settlement.dubbo.AccountService;
import cn.com.cdboost.charge.settlement.dubbo.MonthAccountService;
import cn.com.cdboost.charge.settlement.vo.info.PrePayInfo;
import cn.com.cdboost.charge.settlement.vo.info.UserAccountInfo;
import cn.com.cdboost.charge.settlement.vo.param.AccountQueryVo;
import cn.com.cdboost.charge.settlement.vo.param.MonthConfirmRechargeVo;
import cn.com.cdboost.charge.settlement.vo.param.PrePayVo;
import cn.com.cdboost.charge.user.dubbo.SmsService;
import com.alibaba.dubbo.config.annotation.Reference;
import com.alibaba.dubbo.config.annotation.Service;
import com.alibaba.fastjson.JSON;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.util.CollectionUtils;
import tk.mybatis.mapper.entity.Condition;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.math.BigDecimal;
import java.util.*;

/**
 * 客户服务实现
 */
@Slf4j
@Service(version = "1.0",retries = -1)
public class CustomerServiceImpl implements CustomerService {

    @Reference(version = "1.0")
    private DeviceService deviceService;
    @Reference(version = "1.0")
    private ProjectService projectService;
    @Reference(version = "1.0")
    private PaySchemeService paySchemeService;
    @Reference(version = "1.0")
    private AccountService accountService;
    @Reference(version = "1.0")
    private MonthAccountService monthAccountService;
    @Reference(version = "1.0")
    private WechatService wechatService;
    @Reference(version = "1.0")
    private AlipayService alipayService;
    @Reference(version = "1.0")
    private SmsService smsService;
    @Resource
    private ICustomerInfoService iCustomerInfoService;
    @Resource
    private ICustomerPayService iCustomerPayService;
    @Resource
    private IDeviceUseDetailedService iDeviceUseDetailedService;
    @Resource
    private IDeviceLogService iDeviceLogService;
    @Resource
    private ICustomerPayCardService iCustomerPayCardService;
    @Resource
    private DeviceLogMapper deviceLogMapper;
    @Resource
    private DeviceUseDetailedMapper deviceUseDetailedMapper;
    @Resource
    private CustomerPayCardMapper customerPayCardMapper;

    @Reference(version = "1.0")
    private IcCardService icCardService;

    @Override
    public CustomerBaseInfo queryByParams(Integer appType, String openId) {
        CustomerInfo customerInfo;
        if (CustomerConstant.AppType.WECHAT.getType().equals(appType)) {
            customerInfo = iCustomerInfoService.queryByOpenId(openId);
        } else {
            customerInfo = iCustomerInfoService.queryByAlipayUserId(openId);
        }

        if (customerInfo != null) {
            CustomerBaseInfo baseInfo = new CustomerBaseInfo();
            BeanUtils.copyProperties(customerInfo,baseInfo);
            return baseInfo;
        }

        return null;
    }

    @Override
    public CustomerBaseInfo queryBaseInfo(CustomerQueryParam queryParam) {
        log.info("客户基本信查询CustomerQueryParam={}", JSON.toJSONString(queryParam));
        String customerGuid = queryParam.getCustomerGuid();
        String customerContact = queryParam.getCustomerContact();
        String webcharNo = queryParam.getWebcharNo();
        String alipayUserId = queryParam.getAlipayUserId();
        if (StringUtils.isBlank(customerGuid)
                || StringUtils.isBlank(customerContact)
                || StringUtils.isBlank(webcharNo)
                || StringUtils.isBlank(alipayUserId)) {
            throw new BusinessException("对象查询字段不能全为空");
        }

        CustomerInfo param = new CustomerInfo();
        BeanUtils.copyProperties(queryParam,param);
        CustomerInfo customerInfo = iCustomerInfoService.queryCustomerInfo(param);
        CustomerBaseInfo baseInfo = new CustomerBaseInfo();
        BeanUtils.copyProperties(customerInfo,baseInfo);
        return baseInfo;
    }

    @Override
    public List<PayOrderInfo> queryPayOrderInfos(PayOrderQueryParam queryParam) {
        log.info("客户充值订单查询PayOrderQueryParam={}",JSON.toJSONString(queryParam));
        List<CustomerPay> customerPays = iCustomerPayService.queryPayOrders(queryParam);
        List<PayOrderInfo> dataList = Lists.newArrayList();
        if (CollectionUtils.isEmpty(customerPays)) {
            return dataList;
        }

        for (CustomerPay customerPay : customerPays) {
            PayOrderInfo orderInfo = new PayOrderInfo();
            BeanUtils.copyProperties(customerPay,orderInfo);
            dataList.add(orderInfo);
        }
        return dataList;
    }

    @Override
    public List<ChargeOrderInfo> queryChargeOrderInfos(ChargeOrderQueryParam queryParam) {
        log.info("客户充电订单查询ChargeOrderQueryParam={}",JSON.toJSONString(queryParam));
        List<DeviceUseDetailed> useDetaileds = iDeviceUseDetailedService.queryChargeOrders(queryParam);
        List<ChargeOrderInfo> dataList = Lists.newArrayList();
        if (CollectionUtils.isEmpty(useDetaileds)) {
            return dataList;
        }

        for (DeviceUseDetailed useDetailed : useDetaileds) {
            ChargeOrderInfo orderInfo = new ChargeOrderInfo();
            BeanUtils.copyProperties(useDetailed,orderInfo);
            dataList.add(orderInfo);
        }
        return dataList;
    }

    @Override
    public ChargeOrderInfo queryChargingOrderByCustomerGuid(String customerGuid) {
        log.info("客户充电中记录查询customerGuid={}",customerGuid);
        DeviceUseDetailed deviceUseDetailed = iDeviceUseDetailedService.queryChargingOrder(customerGuid);
        ChargeOrderInfo info = new ChargeOrderInfo();
        if (deviceUseDetailed != null) {
            BeanUtils.copyProperties(deviceUseDetailed,info);
        }
        return info;
    }

    @Override
    public ChargeOrderInfo queryChargingOrderByChargingGuid(String chargingGuid) {
        log.info("客户充电中记录查询chargingGuid={}",chargingGuid);
        DeviceUseDetailed useDetailed = iDeviceUseDetailedService.queryChargeOrder(chargingGuid);
        ChargeOrderInfo orderInfo = new ChargeOrderInfo();
        BeanUtils.copyProperties(useDetailed,orderInfo);
        return orderInfo;
    }

    @Override
    public ChargeRealDataInfo queryChargeRealDataInfo(String chargingGuid) {
        log.info("客户充电中实时数据查询chargingGuid={}",chargingGuid);
        DeviceUseDetailed useDetailed = iDeviceUseDetailedService.queryChargeOrder(chargingGuid);
        ChargeRealDataInfo dataInfo = new ChargeRealDataInfo();
        BeanUtils.copyProperties(useDetailed,dataInfo);

        // 查询设备充电日志表
        Integer devLogId = useDetailed.getDevLogId();
        if (devLogId != null) {
            DeviceLog deviceLog = iDeviceLogService.selectByPrimaryKey(devLogId);
            dataInfo.setChargingPercent(deviceLog.getChargingPercent());
            dataInfo.setPower(deviceLog.getPower());
        } else {
            dataInfo.setChargingPercent(MathUtil.setPrecision(BigDecimal.ZERO));
            dataInfo.setPower(BigDecimal.ZERO);
        }

        return dataInfo;
    }

    @Override
    public WechatChargeInfo wechatCharge(WechatChargeVo chargeVo) {
        log.info("客户微信开电接口WechatChargeVo={}",JSON.toJSONString(chargeVo));
        String deviceNo = chargeVo.getDeviceNo().substring(0,7);
        String port = chargeVo.getDeviceNo().substring(7,chargeVo.getDeviceNo().length());
        DeviceVo deviceVo = deviceService.queryDevice(deviceNo, port);
        String commNo = deviceVo.getCommNo();

        WechatChargeInfo chargeInfo = new WechatChargeInfo();
        //获取价格方案的金额
        String schemeGuid = chargeVo.getSchemeGuid();
        PaySchemeVo paySchemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);
        Integer maxPower = paySchemeVo.getMaxPower();

        // 查询用户账户余额
        String userGuid = chargeVo.getCustomerGuid();
        chargeInfo.setIsCharge(1);

        Integer chargingTime = paySchemeVo.getChargingTime();
        Integer openMeans = CustomerConstant.OpenMeansConstant.WECHAT.getType();
        //针对不包月购买次数的用户
        Integer payCategory = paySchemeVo.getPayCategory();
        if(SchemeConstant.SchemePayCategory.TEMPORARY_RECHARGE.getType().equals(payCategory) ||
                SchemeConstant.SchemePayCategory.RECHARGE_FULL.getType().equals(payCategory)) {
            //获取用户余额，和传入价格方案的金额进行对比
            PrePayVo prePayVo = new PrePayVo();
            prePayVo.setPayMoney(paySchemeVo.getRealMoney());
            // TODO
            prePayVo.setSignGuid(UuidUtil.getUuid());
            prePayVo.setUserGuid(userGuid);
            PrePayInfo prePayInfo = accountService.prePay(prePayVo);
            BigDecimal thirdPayMoney = prePayInfo.getThirdPayMoney();
            boolean greateThanZero = MathUtil.isGreateThanZero(thirdPayMoney);
            if (greateThanZero) {
                // 需要第三方支付
                chargeInfo.setIsCharge(0);
                chargeInfo.setPay(MathUtil.setPrecision(thirdPayMoney));

                // 统一下单
                WxUnifiedOrderParam orderParam = new WxUnifiedOrderParam();
                orderParam.setBody("充电桩充电");
                String outTradeNo = UuidUtil.getUuid();
                orderParam.setOutTradeNo(outTradeNo);
                Integer totalFee = MathUtil.yuan2Fen(String.valueOf(thirdPayMoney));
                orderParam.setTotalFee(totalFee);
                orderParam.setSpbillCreateIp(chargeVo.getIp());
                // TODO 配置文件中获取
                orderParam.setNotifyUrl("");
                orderParam.setTradeType("JSAPI");
                String openId = chargeVo.getOpenId();
                orderParam.setOpenId(openId);
                Map<String, String> orderMap = wechatService.unifiedOrder(orderParam);
                if (!orderMap.isEmpty()) {
                    // 插入支付记录
                    CustomerPay customerPay = new CustomerPay();
                    customerPay.setCustomerGuid(userGuid);
                    //设置用户充值金额,单位元
                    customerPay.setPayMoney(thirdPayMoney);
                    customerPay.setAccountChargeMoney(thirdPayMoney);
                    customerPay.setSchemeGuid(schemeGuid);
                    customerPay.setAccountDeductMoney(BigDecimal.ZERO);
                    customerPay.setChargingTime(paySchemeVo.getChargingTime());
                    customerPay.setPayCategory(payCategory);
                    customerPay.setBuyCnt(0);
                    customerPay.setWebcharNo(openId);
                    customerPay.setCreateTime(new Date());
                    customerPay.setPayFlag(outTradeNo);
                    customerPay.setPayState(0);
                    customerPay.setSerialNum(DateUtil.getSerialNum());
                    // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
                    // 充值成功后，在回调处还会更新此字段
                    customerPay.setAfterRemainAmount(prePayInfo.getBalancePayMoney());
                    customerPay.setType(CustomerConstant.PayScene.CHARGE_ELEC.getType());
                    customerPay.setPayWay(CustomerConstant.PayWayConstant.WECHAT.getType());
                    iCustomerPayService.insertSelective(customerPay);

                    //设置微信下单参数
                    chargeInfo.setAppId(orderMap.get("appId"));
                    chargeInfo.setNonceStr(orderMap.get("nonceStr"));
                    chargeInfo.setTimeStamp(orderMap.get("timeStamp"));
                    chargeInfo.setPackages(orderMap.get("package"));
                    chargeInfo.setPaySign(orderMap.get("paySign"));
                    chargeInfo.setSignType(orderMap.get("signType"));
                }
            } else {
                // 直接余额扣除，发送充电指令

            }
        } else if(SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)){
            // 包月用户的处理

        }
        return chargeInfo;
    }


    @Override
    public AlipayChargeInfo alipayCharge(AlipayChargeVo chargeVo) {
        log.info("客户支付宝开电接口AlipayChargeVo={}",JSON.toJSONString(chargeVo));
        // 查询价格方案
        String schemeGuid = chargeVo.getSchemeGuid();
        PaySchemeVo paySchemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);
        Integer chargingTime = paySchemeVo.getChargingTime();


        // 查询用户账户信息
        AlipayChargeInfo dto = new AlipayChargeInfo();
        dto.setIsCharge(1);
        Integer payCategory = paySchemeVo.getPayCategory();
        Integer openMeans = CustomerConstant.OpenMeansConstant.ALIPAY.getType();
        if(SchemeConstant.SchemePayCategory.TEMPORARY_RECHARGE.getType().equals(payCategory)
                || SchemeConstant.SchemePayCategory.RECHARGE_FULL.getType().equals(payCategory)) {
            //获取用户余额，和传入价格方案的金额进行对比
            PrePayVo prePayVo = new PrePayVo();
            prePayVo.setPayMoney(paySchemeVo.getRealMoney());
            // TODO
            prePayVo.setSignGuid(UuidUtil.getUuid());
            String customerGuid = chargeVo.getCustomerGuid();
            prePayVo.setUserGuid(customerGuid);
            PrePayInfo prePayInfo = accountService.prePay(prePayVo);
            BigDecimal thirdPayMoney = prePayInfo.getThirdPayMoney();
            boolean greateThanZero = MathUtil.isGreateThanZero(thirdPayMoney);
            if (greateThanZero) {
                // 需要第三方支付
                TradeCreateParam param = new TradeCreateParam();
                String outTradeNo = UuidUtil.getUuid();
                param.setOutTradeNo(outTradeNo);
                param.setTotalAmount(String.valueOf(thirdPayMoney));
                param.setSubject("充电桩充电");
                param.setBuyerId(chargeVo.getAlipayUserId());
                String tradeNo = alipayService.tradeCreate(param);
                if (StringUtils.isNotBlank(tradeNo)) {
                    dto.setIsCharge(0);
                    dto.setTradeNo(tradeNo);

                    // 插入支付记录
                    CustomerPay customerPay = new CustomerPay();
                    customerPay.setCustomerGuid(customerGuid);
                    customerPay.setWebcharNo(chargeVo.getAlipayUserId());
                    customerPay.setSchemeGuid(schemeGuid);
                    customerPay.setPayCategory(payCategory);
                    customerPay.setNumMonths(paySchemeVo.getNumMonths());
                    customerPay.setPayMoney(thirdPayMoney);
                    customerPay.setAccountChargeMoney(BigDecimal.ZERO);
                    customerPay.setAccountDeductMoney(BigDecimal.ZERO);
                    customerPay.setBuyCnt(0);
                    customerPay.setChargingTime(chargingTime);
                    customerPay.setSerialNum(DateUtil.getSerialNum());
                    customerPay.setPayFlag(outTradeNo);
                    customerPay.setCreateTime(new Date());
                    customerPay.setPayState(0);
                    // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
                    // 充值成功后，在回调处还会更新此字段
                    customerPay.setAfterRemainAmount(prePayInfo.getBalancePayMoney());
                    customerPay.setType(CustomerConstant.PayScene.CHARGE_ELEC.getType());
                    customerPay.setPayWay(CustomerConstant.PayWayConstant.ALIPAY.getType());
                    iCustomerPayService.insertSelective(customerPay);
                }
            } else {
                // 钱够，就直接下发充电指令
            }
        } else if(SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)){
            // 包月用户的处理

        }
        return dto;
    }

    @Override
    public PageData<ChargeHistoryInfo> queryChargeHistory(ChargeHistoryVo historyVo) {
        log.info("分页查询客户充电历史记录ChargeHistoryVo={}",JSON.toJSONString(historyVo));

        ChargeOrderQueryParam param = new ChargeOrderQueryParam();
        BeanUtils.copyProperties(historyVo,param);
        param.setState(1);
        PageData<DeviceUseDetailed> tempPageData = iDeviceUseDetailedService.queryChargeHistory(historyVo.getCustomerGuid(), historyVo.getPageNumber(), historyVo.getPageSize());
        List<DeviceUseDetailed> list = tempPageData.getList();
        PageData<ChargeHistoryInfo> pageData = new PageData<>();
        if (CollectionUtils.isEmpty(list)) {
            pageData.setTotal(0L);
            pageData.setList(new ArrayList<>());
            return pageData;
        }

        Set<String> set = Sets.newHashSet();
        List<Object> devLogIds = Lists.newArrayList();
        for (DeviceUseDetailed useDetailed : list) {
            set.add(useDetailed.getChargingPlieGuid());
            devLogIds.add(useDetailed.getDevLogId());
        }

        // 批量查询设备信息
        List<String> deviceGuids = Lists.newArrayList(set);
        List<DeviceVo> deviceVos = deviceService.queryDevices(deviceGuids);

        // 转map
        Map<String,DeviceVo> deviceMap = Maps.newHashMap();
        for (DeviceVo deviceVo : deviceVos) {
            deviceMap.put(deviceVo.getChargingPlieGuid(),deviceVo);
        }

        // 批量查询设备日志表信息
        Map<Integer, DeviceLog> deviceLogMap = iDeviceLogService.batchQuery2Map(devLogIds);

        List<ChargeHistoryInfo> dataList = Lists.newArrayList();
        for (DeviceUseDetailed useDetailed : list) {
            ChargeHistoryInfo historyInfo = new ChargeHistoryInfo();
            Integer devLogId = useDetailed.getDevLogId();
            DeviceLog deviceLog = deviceLogMap.get(devLogId);
            Integer eventCode = deviceLog.getEventCode();
            if (eventCode != null) {
                if (eventCode == -2) {
                    // 表示异常导致充电结束
                    historyInfo.setIsEvent(1);
                    historyInfo.setIsEventDesc(deviceLog.getSmsContent());
                } else if (eventCode == -1) {
                    // 正常结束
                    historyInfo.setIsEvent(0);
                } else {
                    // 正常情况，代码不可能执行到此处
                    historyInfo.setIsEvent(0);
                    log.info("代码执行到此处，系统存在bug");
                }
            }

            // 设置设备信息
            DeviceVo deviceVo = deviceMap.get(useDetailed.getChargingPlieGuid());
            historyInfo.setDeviceNo(deviceVo.getDeviceNo() + deviceVo.getPort());
            historyInfo.setInstallAddr(deviceVo.getInstallAddr());
            // 其他信息
            Integer payCategory = useDetailed.getPayCategory();
            historyInfo.setPayWay(payCategory);
            historyInfo.setRemainAmount(useDetailed.getAfterRemainAmount());
            historyInfo.setRemainCnt(useDetailed.getAfterRemainCnt());
            String chargeDate = DateUtil.formatDay(useDetailed.getCreateTime());
            historyInfo.setChargeDate(chargeDate);
            String startTime = DateUtil.formatDate(useDetailed.getStartTime());
            historyInfo.setStartTime(startTime);
            String endTime = DateUtil.formatDate(useDetailed.getEndTime());
            historyInfo.setEndTime(endTime);
            String chargeTime = DateUtil.subTime(useDetailed.getEndTime(), useDetailed.getStartTime());
            historyInfo.setChargeTime(chargeTime);
            historyInfo.setChargingGuid(useDetailed.getChargingGuid());

            this.setPayWayDesc(historyInfo,useDetailed);
            dataList.add(historyInfo);
        }

        pageData.setTotal(tempPageData.getTotal());
        pageData.setList(dataList);
        return pageData;
    }

    private void setPayWayDesc(ChargeHistoryInfo historyInfo,DeviceUseDetailed useDetailed) {
        Integer payCategory = useDetailed.getPayCategory();
        BigDecimal refundMoney = useDetailed.getRefundMoney();
        boolean greateThanZero = MathUtil.isGreateThanZero(refundMoney);
        if (SchemeConstant.SchemePayCategory.TEMPORARY_RECHARGE.getType().equals(payCategory)
                || SchemeConstant.SchemePayCategory.RECHARGE_FULL.getType().equals(payCategory)) {
            if (greateThanZero) {
                // 有退款
                BigDecimal payMoney = MathUtil.sub(useDetailed.getDeductMoney(), refundMoney);
                String desc = CustomerConstant.ChargeDeductWay.PAY_USER_BALANCE.getPayWayDesc() + payMoney.toString() +  "元";
                historyInfo.setPayWayDesc(desc);
            } else {
                String desc = CustomerConstant.ChargeDeductWay.PAY_USER_BALANCE.getPayWayDesc() + useDetailed.getDeductMoney() +  "元";
                historyInfo.setPayWayDesc(desc);
            }
        } else if(SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)) {
            if (greateThanZero) {
                // 有退款
                String desc = CustomerConstant.ChargeDeductWay.PAY_MONTH_CNT.getPayWayDesc()  +  "0次";
                historyInfo.setPayWayDesc(desc);
            } else {
                String desc = CustomerConstant.ChargeDeductWay.PAY_MONTH_CNT.getPayWayDesc() + useDetailed.getDeductCnt()+  "次";
                historyInfo.setPayWayDesc(desc);
            }
        } else if (SchemeConstant.SchemePayCategory.IC_RECHARGE.getType().equals(payCategory)) {
            if (greateThanZero) {
                // 有退款
                BigDecimal payMoney = MathUtil.sub(useDetailed.getDeductMoney(), refundMoney);
                String desc = CustomerConstant.ChargeDeductWay.IC_CARD_BALANCE.getPayWayDesc() + payMoney.toString() +  "元";
                historyInfo.setPayWayDesc(desc);
            } else {
                String desc = CustomerConstant.ChargeDeductWay.IC_CARD_BALANCE.getPayWayDesc() + useDetailed.getDeductMoney() +  "元";
                historyInfo.setPayWayDesc(desc);
            }
        }
    }

    @Override
    public PageData<PayHistoryInfo> queryPayHistory(PayHistoryVo historyVo) {
        log.info("客户支付历史记录查询PayHistoryVo={}",JSON.toJSONString(historyVo));
        PageData<CustomerPay> tempPageData = iCustomerPayService.queryPayHistorys(historyVo.getCustomerGuid(), historyVo.getPageNumber(), historyVo.getPageSize());
        List<CustomerPay> list = tempPageData.getList();
        PageData<PayHistoryInfo> pageData = new PageData<>();
        if (CollectionUtils.isEmpty(list)) {
            pageData.setTotal(0L);
            pageData.setList(new ArrayList<>());
            return pageData;
        }

        List<PayHistoryInfo> dataList = Lists.newArrayList();
        for (CustomerPay customerPay : list) {
            PayHistoryInfo historyInfo = new PayHistoryInfo();
            Integer payCategory = customerPay.getPayCategory();
            if (SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)) {
                historyInfo.setPayCategoryDesc("月卡包月");
                String expireDate = DateUtil.formatDay(customerPay.getExpireTime());
                historyInfo.setExpireTime(expireDate);
            } else {
                historyInfo.setPayCategoryDesc("账户充值");
            }
            historyInfo.setPayCategory(customerPay.getPayCategory());
            historyInfo.setPayMoney(customerPay.getPayMoney());
            historyInfo.setRemainAmount(customerPay.getAfterRemainAmount());
            String payDate = DateUtil.formatDay(customerPay.getCreateTime());
            historyInfo.setPayDate(payDate);
            historyInfo.setPayWay(customerPay.getPayWay());
            StringBuffer sb = new StringBuffer();
            Integer payWay = customerPay.getPayWay();
            String descByType = CustomerConstant.PayWayConstant.getDescByType(payWay);
            BigDecimal payMoney = customerPay.getPayMoney();
            BigDecimal accountDeductMoney = customerPay.getAccountDeductMoney();
            sb.append(descByType).append(payMoney).append("元");
            if (accountDeductMoney != null) {
                if (MathUtil.isGreateThanZero(accountDeductMoney)) {
                    sb.append(",余额支付").append(accountDeductMoney).append("元");
                }
            }
            historyInfo.setPayWayDesc(sb.toString());
            dataList.add(historyInfo);
        }

        pageData.setTotal(tempPageData.getTotal());
        pageData.setList(dataList);
        return pageData;
    }

    @Override
    public PageData<MessageListInfo> queryMessageListInfo(MessageListVo listVo) {
        log.info("客户充电日志消息列表查询MessageListVo={}",JSON.toJSONString(listVo));
        MessageListQueryDto queryDto = new MessageListQueryDto();
        queryDto.setCustomerGuid(listVo.getCustomerGuid());
        queryDto.setPageIndex(listVo.getPageNumber() - 1);
        queryDto.setPageSize(listVo.getPageSize());
        List<MessageListDto> messageList = deviceLogMapper.queryLogMessageList(queryDto);
        List<MessageListInfo> dataList = Lists.newArrayList();
        PageData<MessageListInfo> pageData = new PageData<>();
        if (CollectionUtils.isEmpty(messageList)) {
            pageData.setTotal(0L);
            pageData.setList(dataList);
            return pageData;
        }

        Set<String> set = Sets.newHashSet();
        for (MessageListDto dto : messageList) {
            set.add(dto.getChargingPlieGuid());
        }

        List<String> pileGuids = Lists.newArrayList(set);
        List<DeviceVo> deviceVos = deviceService.queryDevices(pileGuids);
        Map<String,DeviceVo> deviceMap = Maps.newHashMap();
        for (DeviceVo deviceVo : deviceVos) {
            deviceMap.put(deviceVo.getChargingPlieGuid(),deviceVo);
        }

        for (MessageListDto dto : messageList) {
            MessageListInfo info = new MessageListInfo();
            DeviceVo deviceVo = deviceMap.get(dto.getChargingPlieGuid());
            info.setDeviceNo(deviceVo.getDeviceNo() + deviceVo.getPort());
            info.setMessageContent(dto.getSmsContent());
            Integer eventCode = dto.getEventCode();
            info.setMessageType(eventCode);
            String createTime = DateUtil.formatDate(dto.getCreateTime());
            info.setCreateTime(createTime);
            String descByType = CustomerConstant.MessageType.getDescByType(eventCode);
            info.setMessageTypeDesc(descByType);
            info.setChargingGuid(dto.getChargingGuid());

            String date = DateUtil.formatDay(dto.getCreateTime());
            info.setDate(date);
            String time = DateUtil.formatDate(dto.getCreateTime());
            info.setTime(time);
            dataList.add(info);
        }

        // 查询总数
        Long total = deviceLogMapper.queryLogMessageListCount(queryDto);
        pageData.setTotal(total);
        pageData.setList(dataList);
        return pageData;
    }

    @Override
    public LatestChargeOrderInfo queryLatestChargeRecord(String customerGuid) {
        log.info("客户最近一次开电记录查询customerGuid={}",customerGuid);
        DeviceUseDetailed useDetailed = iDeviceUseDetailedService.queryLatestChargeOrder(customerGuid);
        if (useDetailed == null) {
            return null;
        }

        LatestChargeOrderInfo recordInfo = new LatestChargeOrderInfo();
        recordInfo.setChargingGuid(useDetailed.getChargingGuid());
        recordInfo.setChargingPlieGuid(useDetailed.getChargingPlieGuid());
        String startTime = DateUtil.formatDate(useDetailed.getStartTime());
        recordInfo.setStartTime(startTime);
        DeviceLog deviceLog = iDeviceLogService.selectByPrimaryKey(useDetailed.getDevLogId());
        Integer eventCode = deviceLog.getEventCode();
        if (eventCode == -2) {
            // 表示异常导致充电结束
            recordInfo.setIsEvent(0);
            recordInfo.setEventCodeDesc(deviceLog.getSmsContent());
            recordInfo.setEventCode(deviceLog.getEventCode());
        } else if (eventCode == -1) {
            // 正常结束
            recordInfo.setIsEvent(1);
            recordInfo.setEventCodeDesc(deviceLog.getSmsContent());
            recordInfo.setEventCode(deviceLog.getEventCode());
        } else {
            // 正常情况，代码不可能执行到此处
            recordInfo.setEventCodeDesc(deviceLog.getSmsContent());
            recordInfo.setIsEvent(1);
            recordInfo.setEventCode(deviceLog.getEventCode());
            log.info("代码执行到此处，系统存在bug");
        }
        return recordInfo;
    }

    @Override
    public WechatPayOrderInfo wechatBalanceRecharge(WxBalanceRechargeVo rechargeVo) {
        log.info("微信发起账户余额充值WxBalanceRechargeVo={}",JSON.toJSONString(rechargeVo));
        // 查询方案
        String schemeGuid = rechargeVo.getSchemeGuid();
        PaySchemeVo paySchemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);

        // 统一下单
        WxUnifiedOrderParam orderParam = new WxUnifiedOrderParam();
        orderParam.setBody("充电用户账户余额充值");
        String outTradeNo = UuidUtil.getUuid();
        orderParam.setOutTradeNo(outTradeNo);
        BigDecimal payMoney = paySchemeVo.getPayMoney();
        Integer totalFee = MathUtil.yuan2Fen(String.valueOf(payMoney));
        orderParam.setTotalFee(totalFee);
        orderParam.setSpbillCreateIp(rechargeVo.getIp());
        // TODO 配置文件中获取
        orderParam.setNotifyUrl("");
        orderParam.setTradeType("JSAPI");
        String openId = rechargeVo.getOpenId();
        orderParam.setOpenId(openId);
        Map<String, String> orderMap = wechatService.unifiedOrder(orderParam);
        WechatPayOrderInfo orderInfo = new WechatPayOrderInfo();
        if (!orderMap.isEmpty()) {
            // 插入支付记录
            CustomerPay customerPay = new CustomerPay();
            String customerGuid = rechargeVo.getCustomerGuid();
            customerPay.setCustomerGuid(customerGuid);
            customerPay.setPayMoney(payMoney);
            customerPay.setAccountChargeMoney(paySchemeVo.getRealMoney());
            customerPay.setSchemeGuid(schemeGuid);
            customerPay.setAccountDeductMoney(BigDecimal.ZERO);
            customerPay.setChargingTime(paySchemeVo.getChargingTime());
            customerPay.setPayCategory(paySchemeVo.getPayCategory());
            customerPay.setBuyCnt(0);
            customerPay.setWebcharNo(openId);
            customerPay.setCreateTime(new Date());
            customerPay.setPayFlag(outTradeNo);
            customerPay.setPayState(0);
            customerPay.setSerialNum(DateUtil.getSerialNum());

            AccountQueryVo queryVo = new AccountQueryVo();
            queryVo.setAccountGuid(customerGuid);
            queryVo.setAccountCode(AccountDictEnum.CUSTOMER_AVAILABLE.getAccountCode());
            UserAccountInfo accountInfo = accountService.queryAccountInfo(queryVo);
            // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
            // 充值成功后，在回调处还会更新此字段
            customerPay.setAfterRemainAmount(accountInfo.getRemainAmount());
            customerPay.setType(CustomerConstant.PayScene.ACTIVITY_CHARGE.getType());
            customerPay.setPayWay(CustomerConstant.PayWayConstant.WECHAT.getType());
            iCustomerPayService.insertSelective(customerPay);

            //设置微信下单参数
            orderInfo.setAppId(orderMap.get("appId"));
            orderInfo.setNonceStr(orderMap.get("nonceStr"));
            orderInfo.setTimeStamp(orderMap.get("timeStamp"));
            orderInfo.setPackages(orderMap.get("package"));
            orderInfo.setPaySign(orderMap.get("paySign"));
            orderInfo.setSignType(orderMap.get("signType"));
        }
        return orderInfo;
    }

    @Override
    public String alipayBalanceRecharge(ZfbBalanceRechargeVo rechargeVo) {
        log.info("支付宝发起账户余额充值ZfbBalanceRechargeVo={}",JSON.toJSONString(rechargeVo));
        // 查询方案
        String schemeGuid = rechargeVo.getSchemeGuid();
        PaySchemeVo paySchemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);

        TradeCreateParam param = new TradeCreateParam();
        String outTradeNo = UuidUtil.getUuid();
        param.setOutTradeNo(outTradeNo);
        BigDecimal payMoney = paySchemeVo.getPayMoney();
        param.setTotalAmount(String.valueOf(payMoney));
        param.setSubject("充电用户账户余额充值");
        param.setBuyerId(rechargeVo.getAlipayUserId());
        String tradeNo = alipayService.tradeCreate(param);
        if (StringUtils.isNotBlank(tradeNo)) {
            // 插入支付记录
            CustomerPay customerPay = new CustomerPay();
            String customerGuid = rechargeVo.getCustomerGuid();
            customerPay.setCustomerGuid(customerGuid);
            customerPay.setWebcharNo(rechargeVo.getAlipayUserId());
            customerPay.setSchemeGuid(schemeGuid);
            customerPay.setPayCategory(paySchemeVo.getPayCategory());
            customerPay.setPayMoney(payMoney);
            customerPay.setAccountChargeMoney(paySchemeVo.getRealMoney());
            customerPay.setAccountDeductMoney(BigDecimal.ZERO);
            customerPay.setBuyCnt(0);
            customerPay.setChargingTime(paySchemeVo.getChargingTime());
            customerPay.setSerialNum(DateUtil.getSerialNum());
            customerPay.setPayFlag(outTradeNo);
            customerPay.setCreateTime(new Date());
            customerPay.setPayState(0);

            AccountQueryVo queryVo = new AccountQueryVo();
            queryVo.setAccountGuid(customerGuid);
            queryVo.setAccountCode(AccountDictEnum.CUSTOMER_AVAILABLE.getAccountCode());
            UserAccountInfo accountInfo = accountService.queryAccountInfo(queryVo);
            // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
            // 充值成功后，在回调处还会更新此字段
            customerPay.setAfterRemainAmount(accountInfo.getRemainAmount());
            customerPay.setType(CustomerConstant.PayScene.ACTIVITY_CHARGE.getType());
            customerPay.setPayWay(CustomerConstant.PayWayConstant.ALIPAY.getType());
            iCustomerPayService.insertSelective(customerPay);
        }
        return tradeNo;
    }

    @Override
    public ChargeCompleteInfo queryChargeCompleteInfo(String chargingGuid) {
        DeviceUseDetailed useDetailed = iDeviceUseDetailedService.queryChargeOrder(chargingGuid);

        //设置选择充电的套餐类型
        ChargeCompleteInfo completeInfo = new ChargeCompleteInfo();
        this.setCompleteParams(useDetailed,completeInfo);
        Integer devLogId = useDetailed.getDevLogId();
        if (devLogId != null) {
            DeviceLog deviceLog = iDeviceLogService.selectByPrimaryKey(devLogId);
            Integer eventCode = deviceLog.getEventCode();
            if (eventCode == -1) {
                // 手动结束充电
                completeInfo.setIsEvent(0);
            } else if (eventCode == -2) {
                // 异常结束
                //设置异常
                completeInfo.setIsEvent(1);
                completeInfo.setEventCodeDesc(deviceLog.getSmsContent());
            } else {
                // 正常情况，代码不可能进入此处
                completeInfo.setIsEvent(0);
                log.info("代码执行到此处，系统存在bug");
            }
        } else {
            completeInfo.setIsEvent(0);
        }

        return completeInfo;
    }

    private void setCompleteParams(DeviceUseDetailed useDetailed, ChargeCompleteInfo completeInfo){
        BigDecimal refundMoney = useDetailed.getRefundMoney();
        boolean flag = MathUtil.isGreateThanZero(refundMoney);

        Integer payCategory = useDetailed.getPayCategory();
        completeInfo.setPayCategory(payCategory);
        if(SchemeConstant.SchemePayCategory.TEMPORARY_RECHARGE.getType().equals(payCategory)){
            completeInfo.setPayCategoryDesc(SchemeConstant.SchemePayCategory.TEMPORARY_RECHARGE.getDesc());
            //设置充电金额
            if (flag) {
                BigDecimal sub = MathUtil.sub(useDetailed.getDeductMoney(), refundMoney);
                completeInfo.setPayMoney(sub);
            } else {
                completeInfo.setPayMoney(useDetailed.getDeductMoney());
            }

            //设置剩余金额
            completeInfo.setRemainAmount(useDetailed.getAfterRemainAmount());
        } else if(SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)){
            completeInfo.setPayCategoryDesc(SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getDesc());
            //设置扣除次数
            if (flag) {
                completeInfo.setUseCnt(0);
            } else {
                completeInfo.setUseCnt(useDetailed.getDeductCnt());
            }

            //设置剩余次数
            completeInfo.setRemainCnt(useDetailed.getAfterRemainCnt());
        } else if(SchemeConstant.SchemePayCategory.RECHARGE_FULL.getType().equals(payCategory)){
            completeInfo.setPayCategoryDesc(SchemeConstant.SchemePayCategory.RECHARGE_FULL.getDesc());
            //设置充电金额
            if (flag) {
                BigDecimal sub = MathUtil.sub(useDetailed.getDeductMoney(), refundMoney);
                completeInfo.setPayMoney(sub);
            } else {
                completeInfo.setPayMoney(useDetailed.getDeductMoney());
            }
            //设置剩余金额
            completeInfo.setRemainAmount(useDetailed.getAfterRemainAmount());
        } else if(SchemeConstant.SchemePayCategory.IC_RECHARGE.getType().equals(payCategory)) {
            completeInfo.setPayCategoryDesc(SchemeConstant.SchemePayCategory.IC_RECHARGE.getDesc());
            //设置充电金额
            if (flag) {
                BigDecimal sub = MathUtil.sub(useDetailed.getDeductMoney(), refundMoney);
                completeInfo.setPayMoney(sub);
            } else {
                completeInfo.setPayMoney(useDetailed.getDeductMoney());
            }
            //设置剩余金额
            completeInfo.setRemainAmount(useDetailed.getAfterRemainAmount());
        }
        //设置充电时长
        String chargeTime = DateUtil.subTime(useDetailed.getEndTime(), useDetailed.getStartTime());
        completeInfo.setChargeTime(chargeTime);

        //设置开始充电时间
        completeInfo.setStartTime(DateUtil.formatDate(useDetailed.getStartTime()));
        //设置结束充电时间
        completeInfo.setEndTime(DateUtil.formatDate(useDetailed.getEndTime()));
        //设置联系电话
        DeviceDetailVo deviceDetailVo = deviceService.queryDeviceDetail(useDetailed.getChargingPlieGuid());
        completeInfo.setDeviceNo(deviceDetailVo.getDeviceNo() + deviceDetailVo.getPort());
        // TODO
        ProjectVo projectVo = projectService.queryProjectDetail("");
        completeInfo.setContact(projectVo.getContactPhone());
    }


    @Override
    public WxMonthRechargeInfo wechatBuyMonthCard(WxBuyMonthCardVo cardVo) {
        log.info("客户微信月卡购买WxBuyMonthCardVo={}",JSON.toJSONString(cardVo));
        //查询价格方案
        String schemeGuid = cardVo.getSchemeGuid();
        PaySchemeVo schemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);
        Integer payCategory = schemeVo.getPayCategory();
        if (!SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)) {
            throw new BusinessException("价格方案id错误");
        }

        PrePayVo prePayVo = new PrePayVo();
        String customerGuid = cardVo.getCustomerGuid();
        prePayVo.setUserGuid(customerGuid);
        prePayVo.setPayMoney(schemeVo.getRealMoney());
        String outTradeNo = UuidUtil.getUuid();
        prePayVo.setSignGuid(outTradeNo);
        PrePayInfo prePayInfo = accountService.prePay(prePayVo);
        BigDecimal thirdPayMoney = prePayInfo.getThirdPayMoney();
        boolean greateThanZero = MathUtil.isGreateThanZero(thirdPayMoney);
        String openId = cardVo.getOpenId();
        WxMonthRechargeInfo rechargeInfo = new WxMonthRechargeInfo();
        if (greateThanZero) {
            // 统一下单
            WxUnifiedOrderParam orderParam = new WxUnifiedOrderParam();
            orderParam.setBody("充电客户月卡购买");
            orderParam.setOutTradeNo(outTradeNo);
            Integer totalFee = MathUtil.yuan2Fen(String.valueOf(thirdPayMoney));
            orderParam.setTotalFee(totalFee);
            orderParam.setSpbillCreateIp(cardVo.getIp());
            // TODO 配置文件中获取
            orderParam.setNotifyUrl("");
            orderParam.setTradeType("JSAPI");
            orderParam.setOpenId(openId);
            Map<String, String> orderMap = wechatService.unifiedOrder(orderParam);
            if (!orderMap.isEmpty()) {
                // 插入支付记录
                CustomerPay customerPay = new CustomerPay();
                customerPay.setCustomerGuid(customerGuid);
                customerPay.setPayMoney(thirdPayMoney);
                customerPay.setAccountChargeMoney(BigDecimal.ZERO);
                customerPay.setSchemeGuid(schemeGuid);
                customerPay.setAccountDeductMoney(prePayInfo.getBalancePayMoney());
                customerPay.setChargingTime(schemeVo.getChargingTime());
                customerPay.setPayCategory(payCategory);
                customerPay.setBuyCnt(schemeVo.getChargingCnt());
                customerPay.setWebcharNo(openId);
                customerPay.setCreateTime(new Date());
                customerPay.setPayFlag(outTradeNo);
                customerPay.setPayState(0);
                customerPay.setSerialNum(DateUtil.getSerialNum());
                // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
                // 充值成功后，在回调处还会更新此字段
                customerPay.setAfterRemainAmount(prePayInfo.getBalancePayMoney());
                customerPay.setType(CustomerConstant.PayScene.MONTH_CHARGE.getType());
                customerPay.setPayWay(CustomerConstant.PayWayConstant.WECHAT.getType());
                iCustomerPayService.insertSelective(customerPay);

                //设置微信下单参数
                rechargeInfo.setIsPay(1);
                rechargeInfo.setAppId(orderMap.get("appId"));
                rechargeInfo.setNonceStr(orderMap.get("nonceStr"));
                rechargeInfo.setTimeStamp(orderMap.get("timeStamp"));
                rechargeInfo.setPackages(orderMap.get("package"));
                rechargeInfo.setPaySign(orderMap.get("paySign"));
                rechargeInfo.setSignType(orderMap.get("signType"));
            }
        } else {
            rechargeInfo.setIsPay(0);

            // 纯余额购买月卡，生成余额支付订单
            CustomerPay customerPay = new CustomerPay();
            customerPay.setCustomerGuid(customerGuid);
            BigDecimal realMoney = schemeVo.getRealMoney();
            customerPay.setPayMoney(realMoney);
            customerPay.setAccountChargeMoney(BigDecimal.ZERO);
            customerPay.setSchemeGuid(schemeGuid);
            customerPay.setAccountDeductMoney(BigDecimal.ZERO);
            customerPay.setChargingTime(schemeVo.getChargingTime());
            customerPay.setPayCategory(payCategory);
            customerPay.setBuyCnt(schemeVo.getChargingCnt());
            customerPay.setWebcharNo(openId);
            customerPay.setCreateTime(new Date());
            customerPay.setPayFlag(outTradeNo);
            customerPay.setPayState(1);
            customerPay.setSerialNum(DateUtil.getSerialNum());
            // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
            // 充值成功后，在回调处还会更新此字段
            customerPay.setAfterRemainAmount(prePayInfo.getRemainAmount());
            customerPay.setType(CustomerConstant.PayScene.MONTH_CHARGE.getType());
            customerPay.setPayWay(CustomerConstant.PayWayConstant.BALANCE.getType());
            iCustomerPayService.insertSelective(customerPay);

            //调用账户月卡购买接口
            MonthConfirmRechargeVo rechargeVo = new MonthConfirmRechargeVo();
            rechargeVo.setUserGuid(customerGuid);
            rechargeVo.setSchemeGuid(schemeGuid);
            rechargeVo.setSignGuid(outTradeNo);
            rechargeVo.setThirdPayMoney(BigDecimal.ZERO);
            rechargeVo.setBalancePayMoney(realMoney);
            rechargeVo.setChargeCnt(schemeVo.getChargingCnt());
            monthAccountService.confirmRecharge(rechargeVo);
        }
        return rechargeInfo;
    }

    @Override
    public AlipayMonthRechargeInfo alipayBuyMonthCard(ZfbBuyMonthCardVo cardVo) {
        log.info("客户支付宝月卡购买ZfbBuyMonthCardVo={}",JSON.toJSONString(cardVo));
        //查询价格方案
        String schemeGuid = cardVo.getSchemeGuid();
        PaySchemeVo schemeVo = paySchemeService.queryPaySchemeBySchemeGuid(schemeGuid);
        Integer payCategory = schemeVo.getPayCategory();
        if (!SchemeConstant.SchemePayCategory.MONTH_RECHARGE.getType().equals(payCategory)) {
            throw new BusinessException("价格方案id错误");
        }

        PrePayVo prePayVo = new PrePayVo();
        String customerGuid = cardVo.getCustomerGuid();
        prePayVo.setUserGuid(customerGuid);
        prePayVo.setPayMoney(schemeVo.getRealMoney());
        String outTradeNo = UuidUtil.getUuid();
        prePayVo.setSignGuid(outTradeNo);
        PrePayInfo prePayInfo = accountService.prePay(prePayVo);
        BigDecimal thirdPayMoney = prePayInfo.getThirdPayMoney();
        boolean greateThanZero = MathUtil.isGreateThanZero(thirdPayMoney);
        String alipayUserId = cardVo.getAlipayUserId();
        AlipayMonthRechargeInfo rechargeInfo = new AlipayMonthRechargeInfo();
        if (greateThanZero) {
            // 统一下单
            TradeCreateParam param = new TradeCreateParam();
            param.setOutTradeNo(outTradeNo);
            param.setTotalAmount(String.valueOf(thirdPayMoney));
            param.setSubject("充电用户账户余额充值");
            param.setBuyerId(alipayUserId);
            String tradeNo = alipayService.tradeCreate(param);
            if (StringUtils.isNotBlank(tradeNo)) {
                // 插入支付记录
                CustomerPay customerPay = new CustomerPay();
                customerPay.setCustomerGuid(customerGuid);
                customerPay.setWebcharNo(alipayUserId);
                customerPay.setSchemeGuid(schemeGuid);
                customerPay.setPayCategory(schemeVo.getPayCategory());
                customerPay.setPayMoney(thirdPayMoney);
                customerPay.setAccountChargeMoney(BigDecimal.ZERO);
                customerPay.setAccountDeductMoney(prePayInfo.getBalancePayMoney());
                customerPay.setBuyCnt(schemeVo.getChargingCnt());
                customerPay.setChargingTime(schemeVo.getChargingTime());
                customerPay.setSerialNum(DateUtil.getSerialNum());
                customerPay.setPayFlag(outTradeNo);
                customerPay.setCreateTime(new Date());
                customerPay.setPayState(0);
                // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
                // 充值成功后，在回调处还会更新此字段
                customerPay.setAfterRemainAmount(prePayInfo.getBalancePayMoney());
                customerPay.setType(CustomerConstant.PayScene.MONTH_CHARGE.getType());
                customerPay.setPayWay(CustomerConstant.PayWayConstant.ALIPAY.getType());
                iCustomerPayService.insertSelective(customerPay);
            }
        } else {
            rechargeInfo.setIsPay(0);

            // 纯余额购买月卡，生成余额支付订单
            CustomerPay customerPay = new CustomerPay();
            customerPay.setCustomerGuid(customerGuid);
            BigDecimal realMoney = schemeVo.getRealMoney();
            customerPay.setPayMoney(realMoney);
            customerPay.setAccountChargeMoney(BigDecimal.ZERO);
            customerPay.setSchemeGuid(schemeGuid);
            customerPay.setAccountDeductMoney(BigDecimal.ZERO);
            customerPay.setChargingTime(schemeVo.getChargingTime());
            customerPay.setPayCategory(payCategory);
            customerPay.setBuyCnt(schemeVo.getChargingCnt());
            customerPay.setWebcharNo(alipayUserId);
            customerPay.setCreateTime(new Date());
            customerPay.setPayFlag(outTradeNo);
            customerPay.setPayState(1);
            customerPay.setSerialNum(DateUtil.getSerialNum());
            // 充值后剩余金额，此处是先将充值前剩余金额赋值上，避免用户点击支付，然后又取消了，导致支付失败的订单上该字段为null
            // 充值成功后，在回调处还会更新此字段
            customerPay.setAfterRemainAmount(prePayInfo.getRemainAmount());
            customerPay.setType(CustomerConstant.PayScene.MONTH_CHARGE.getType());
            customerPay.setPayWay(CustomerConstant.PayWayConstant.BALANCE.getType());
            iCustomerPayService.insertSelective(customerPay);

            //调用账户月卡购买接口
            MonthConfirmRechargeVo rechargeVo = new MonthConfirmRechargeVo();
            rechargeVo.setUserGuid(customerGuid);
            rechargeVo.setSchemeGuid(schemeGuid);
            rechargeVo.setSignGuid(outTradeNo);
            rechargeVo.setThirdPayMoney(BigDecimal.ZERO);
            rechargeVo.setBalancePayMoney(realMoney);
            rechargeVo.setChargeCnt(schemeVo.getChargingCnt());
            monthAccountService.confirmRecharge(rechargeVo);
        }
        return rechargeInfo;
    }


    @Override
    public boolean register(RegisterVo registerVo) {
        log.info("客户注册RegisterVo={}",JSON.toJSONString(registerVo));
        //验证验证码是否正确
        String phoneNumber = registerVo.getPhoneNumber();
        String verificationCode = registerVo.getVerificationCode();
        boolean flag = smsService.verifySmsCode(phoneNumber, verificationCode);
        if (!flag) {
            // 验证码校验不通过
            return flag;
        }

        Integer appType = registerVo.getAppType();
        String nickName = registerVo.getNickName();
        String openId = registerVo.getOpenId();
        CustomerInfo customerInfo = iCustomerInfoService.queryByCustomerContact(phoneNumber);
        if (customerInfo == null) {
            // 手机号第一次注册
            if (CustomerConstant.AppType.WECHAT.getType().equals(appType)) {
                CustomerInfo info = new CustomerInfo();
                info.setCustomerName(nickName);
                info.setWebcharNo(openId);
                info.setCustomerGuid(UuidUtil.getUuid());
                info.setCustomerContact(phoneNumber);
                info.setCreateTime(new Date());
                iCustomerInfoService.insertSelective(info);
            } else {
                CustomerInfo info = new CustomerInfo();
                info.setAlipayNickName(nickName);
                info.setAlipayUserId(openId);
                info.setCustomerGuid(UuidUtil.getUuid());
                info.setCustomerContact(phoneNumber);
                info.setCreateTime(new Date());
                iCustomerInfoService.insertSelective(info);
            }
        } else {
            if (CustomerConstant.AppType.WECHAT.getType().equals(appType)) {
                // 更新账户绑定微信信息
                customerInfo.setWebcharNo(openId);
                customerInfo.setCustomerName(nickName);
                customerInfo.setUpdateTime(new Date());
                iCustomerInfoService.updateByPrimaryKeySelective(customerInfo);
            } else {
                // 更新账户绑定支付宝信息
                customerInfo.setAlipayUserId(openId);
                customerInfo.setAlipayNickName(nickName);
                customerInfo.setUpdateTime(new Date());
                iCustomerInfoService.updateByPrimaryKeySelective(customerInfo);
            }
        }

        return flag;
    }

    @Override
    public boolean updateCustomerPhone(String customerGuid, String mobilePhone,String validateCode) {
        log.info("设置客户是否接口短信customerGuid={},mobilePhone={}",customerGuid,mobilePhone);
        CustomerInfo customerInfo = iCustomerInfoService.queryByCustomerGuid(customerGuid);
        boolean flag = smsService.verifySmsCode(customerInfo.getCustomerContact(), validateCode);
        if (!flag) {
            return flag;
        }

        // 更新
        CustomerInfo param = new CustomerInfo();
        param.setCustomerGuid(customerGuid);
        param.setCustomerContact(mobilePhone);
        int i = iCustomerInfoService.updateSelectiveByCustomerGuid(param);
        if (i <= 0) {
            throw new BusinessException("更新失败");
        }
        return flag;
    }

    @Override
    public void updateByCustomerGuid(CustomerUpdateVo updateVo) {
        log.info("设置客户是否接口短信CustomerUpdateVo={}",JSON.toJSONString(updateVo));
        CustomerInfo param = new CustomerInfo();
        BeanUtils.copyProperties(updateVo,param);
        int i = iCustomerInfoService.updateSelectiveByCustomerGuid(param);
        if (i <= 0) {
            throw new BusinessException("更新失败");
        }
    }

    @Override
    public WithdrawCashInfo queryWithdrawCashInfo(Integer appType,String customerGuid) {
        log.info("查询客户提现页面信息customerGuid={}",customerGuid);
        CustomerInfo customerInfo = iCustomerInfoService.queryByCustomerGuid(customerGuid);

        WithdrawCashInfo cashInfo = new WithdrawCashInfo();
        if (CustomerConstant.AppType.WECHAT.getType().equals(appType)) {
            String alipayUserId = customerInfo.getAlipayUserId();
            if (StringUtils.isNotBlank(alipayUserId)) {
                cashInfo.setHasAccount(1);
                cashInfo.setUserId(alipayUserId);
            }
        } else {
            String webcharNo = customerInfo.getWebcharNo();
            if (StringUtils.isNotBlank(webcharNo)) {
                cashInfo.setHasAccount(1);
                cashInfo.setUserId(webcharNo);
            }
        }

        AccountQueryVo queryVo = new AccountQueryVo();
        queryVo.setAccountGuid(customerGuid);
        queryVo.setAccountCode(AccountDictEnum.CUSTOMER_AVAILABLE.getAccountCode());
        UserAccountInfo accountInfo = accountService.queryAccountInfo(queryVo);
        cashInfo.setRemainAmount(accountInfo.getRemainAmount());
        cashInfo.setWithdrawCashAmount(accountInfo.getRemainAmount());
        return cashInfo;
    }

    @Override
    public WechatPayOrderInfo iccardRecharge(WxIcCardRechargeVo rechargeVo) {
        log.info("客户微信IC卡充值WxIcCardRechargeVo={}",JSON.toJSONString(rechargeVo));
        // 统一下单
        WxUnifiedOrderParam orderParam = new WxUnifiedOrderParam();
        orderParam.setBody("IC卡账户余额充值");
        String outTradeNo = UuidUtil.getUuid();
        orderParam.setOutTradeNo(outTradeNo);
        BigDecimal amount = rechargeVo.getAmount();
        Integer totalFee = MathUtil.yuan2Fen(String.valueOf(amount));
        orderParam.setTotalFee(totalFee);
        orderParam.setSpbillCreateIp(rechargeVo.getIp());
        // TODO 配置文件中获取
        orderParam.setNotifyUrl("");
        orderParam.setTradeType("JSAPI");
        String openId = rechargeVo.getOpenId();
        orderParam.setOpenId(openId);
        Map<String, String> orderMap = wechatService.unifiedOrder(orderParam);
        WechatPayOrderInfo orderInfo = new WechatPayOrderInfo();
        if (!orderMap.isEmpty()) {
            // 插入支付记录
            CustomerPayCard payCard = new CustomerPayCard();
            String customerGuid = rechargeVo.getCustomerGuid();
            payCard.setCustomerGuid(customerGuid);
            payCard.setProjectGuid(rechargeVo.getProjectGuid());
            payCard.setMerchantGuid(rechargeVo.getMerchantGuid());
            payCard.setPropertyGuid(rechargeVo.getPropertyGuid());
            payCard.setCardId(rechargeVo.getCardId());
            payCard.setPayMoney(amount);
            // TODO 查询IC卡账户余额
            payCard.setAfterRemainAmount(BigDecimal.ZERO);
            payCard.setSerialNum(DateUtil.getSerialNum());
            payCard.setPayFlag(outTradeNo);
            payCard.setPayWay(CustomerConstant.PayWayConstant.WECHAT.getType());
            payCard.setPayState(0);
            payCard.setCreateTime(new Date());
            iCustomerPayCardService.insertSelective(payCard);

            //设置微信下单参数
            orderInfo.setAppId(orderMap.get("appId"));
            orderInfo.setNonceStr(orderMap.get("nonceStr"));
            orderInfo.setTimeStamp(orderMap.get("timeStamp"));
            orderInfo.setPackages(orderMap.get("package"));
            orderInfo.setPaySign(orderMap.get("paySign"));
            orderInfo.setSignType(orderMap.get("signType"));
        }
        return orderInfo;
    }

    @Override
    public String alipayIccardRecharge(ZfbIcCardRechargeVo rechargeVo) {
        log.info("支付宝IC卡充值ZfbIcCardRechargeVo={}",rechargeVo);
        TradeCreateParam param = new TradeCreateParam();
        String outTradeNo = UuidUtil.getUuid();
        param.setOutTradeNo(outTradeNo);
        BigDecimal amount = rechargeVo.getAmount();
        param.setTotalAmount(String.valueOf(amount));
        param.setSubject("IC卡账户余额充值");
        param.setBuyerId(rechargeVo.getAlipayUserId());
        String tradeNo = alipayService.tradeCreate(param);
        if (StringUtils.isNotBlank(tradeNo)) {
            // 插入支付记录
            CustomerPayCard payCard = new CustomerPayCard();
            String customerGuid = rechargeVo.getCustomerGuid();
            payCard.setCustomerGuid(customerGuid);
            payCard.setProjectGuid(rechargeVo.getProjectGuid());
            payCard.setMerchantGuid(rechargeVo.getMerchantGuid());
            payCard.setPropertyGuid(rechargeVo.getPropertyGuid());
            payCard.setCardId(rechargeVo.getCardId());
            payCard.setPayMoney(amount);
            // TODO 查询IC卡账户余额
            payCard.setAfterRemainAmount(BigDecimal.ZERO);
            payCard.setSerialNum(DateUtil.getSerialNum());
            payCard.setPayFlag(outTradeNo);
            payCard.setPayWay(CustomerConstant.PayWayConstant.ALIPAY.getType());
            payCard.setPayState(0);
            payCard.setCreateTime(new Date());
            iCustomerPayCardService.insertSelective(payCard);
        }
        return tradeNo;
    }

    @Override
    public IcCardInfo queryIcCardInfo(String cardId) {
        log.info("查询IC卡使用记录、充值记录等信息cardId={}",cardId);

        IcCardInfo icCardInfo = new IcCardInfo();
        // 查询IC卡可用账户
        AccountQueryVo queryVo = new AccountQueryVo();
        queryVo.setAccountGuid(cardId);
        queryVo.setAccountCode(AccountDictEnum.CUSTOMER_IC_CARD_AVAILABLE.getAccountCode());
        UserAccountInfo accountInfo = accountService.queryAccountInfo(queryVo);
        icCardInfo.setRemainAmount(accountInfo.getRemainAmount());

        // 最近3条使用记录
        List<DeviceUseDetailed> useDetaileds = iDeviceUseDetailedService.queryRecentNList(cardId, 3);
        List<IcCardUseInfo> useInfoList = this.getIcCardUseInfoList(useDetaileds);
        icCardInfo.setUseInfoList(useInfoList);

        // 最近3条充值记录
        List<CustomerPayCard> payCards = iCustomerPayCardService.queryRecentNList(cardId, 3);
        List<IcCardPayInfo> payInfoList = this.getIcCardPayInfoList(payCards);
        icCardInfo.setPayInfoList(payInfoList);
        return icCardInfo;
    }

    /**
     * 获取IC卡使用支付列表
     * @param payList
     * @return
     */
    private List<IcCardPayInfo> getIcCardPayInfoList(List<CustomerPayCard> payList) {
        List<IcCardPayInfo> payInfoList = Lists.newArrayList();
        if (CollectionUtils.isEmpty(payList)) {
            return payInfoList;
        }

        for (CustomerPayCard payCard : payList) {
            IcCardPayInfo payInfo = new IcCardPayInfo();
            payInfo.setCardId(payCard.getCardId());
            payInfo.setPayMoney(payCard.getPayMoney());
            String payMethod = CustomerConstant.PayWayConstant.getDescByType(payCard.getPayWay());
            payInfo.setPayMethod(payMethod);
            payInfo.setPayTime(payCard.getUpdateTime());
            payInfo.setAfterRemainAmount(payCard.getAfterRemainAmount());
            payInfoList.add(payInfo);
        }
        return payInfoList;
    }

    /**
     * 获取IC卡使用记录列表
     * @param useDetaileds
     * @return
     */
    private List<IcCardUseInfo> getIcCardUseInfoList(List<DeviceUseDetailed> useDetaileds) {
        List<IcCardUseInfo> useInfoList = Lists.newArrayList();
        if (CollectionUtils.isEmpty(useDetaileds)) {
            return useInfoList;
        }

        for (DeviceUseDetailed useDetailed : useDetaileds) {
            IcCardUseInfo useInfo = new IcCardUseInfo();
            useInfo.setCardId(useDetailed.getOpenNo());
            useInfo.setDeductMoney(useDetailed.getDeductMoney());
            useInfo.setBeginTime(useDetailed.getStartTime());
            useInfo.setEndTime(useDetailed.getEndTime());
            useInfo.setAfterRemainAmount(useDetailed.getAfterRemainAmount());
            useInfoList.add(useInfo);
        }

        return useInfoList;
    }

    @Override
    public PageData<IcCardUseInfo> queryIcCardUseInfo(CardUseQueryVo queryVo) {
        log.info("分页查询客户IC卡使用记录CardUseQueryVo={}",JSON.toJSONString(queryVo));

        Condition condition = new Condition(DeviceUseDetailed.class);
        Example.Criteria criteria = condition.createCriteria();
        criteria.orEqualTo("customerGuid",queryVo.getCustomerGuid());
        criteria.orEqualTo("customerGuid","");
        criteria.orIsNull("customerGuid");

        Example.Criteria criteria1 = condition.createCriteria();
        criteria1.andEqualTo("openNo",queryVo.getCardId());
        criteria1.andEqualTo("state",CustomerConstant.DeviceUsedRecordState.FINISH.getState());
        condition.and(criteria1);

        PageHelper.startPage(queryVo.getPageNumber(),queryVo.getPageSize(),"end_time desc");
        List<DeviceUseDetailed> list = deviceUseDetailedMapper.selectByCondition(condition);
        PageInfo<DeviceUseDetailed> pageInfo = new PageInfo(list);

        List<IcCardUseInfo> icCardUseInfo = this.getIcCardUseInfoList(list);
        PageData<IcCardUseInfo> pageData = new PageData<>();
        pageData.setTotal(pageInfo.getTotal());
        pageData.setList(icCardUseInfo);
        return pageData;
    }

    @Override
    public PageData<IcCardPayInfo> queryIcCardPayInfo(CardPayQueryVo queryVo) {
        log.info("分页查询客户IC卡支付记录CardPayQueryVo={}",JSON.toJSONString(queryVo));
        Condition condition = new Condition(CustomerPayCard.class);
        Example.Criteria criteria = condition.createCriteria();
        criteria.orEqualTo("customerGuid",queryVo.getCustomerGuid());
        criteria.orEqualTo("customerGuid","");
        criteria.orIsNull("customerGuid");

        Example.Criteria criteria1 = condition.createCriteria();
        criteria1.andEqualTo("cardId",queryVo.getCardId());
        criteria1.andEqualTo("payState",CustomerConstant.PayState.PAY_SUCCESS.getState());
        condition.and(criteria1);

        PageHelper.startPage(queryVo.getPageNumber(),queryVo.getPageSize(),"id desc");
        List<CustomerPayCard> payCards = customerPayCardMapper.selectByCondition(condition);
        PageInfo<CustomerPayCard> pageInfo = new PageInfo(payCards);

        List<IcCardPayInfo> icCardPayInfoList = this.getIcCardPayInfoList(payCards);
        PageData<IcCardPayInfo> pageData = new PageData<>();
        pageData.setTotal(pageInfo.getTotal());
        pageData.setList(icCardPayInfoList);
        return pageData;
    }

    @Override
    public List<ChargingIcCardInfo> queryChargingIcCardInfo(String customerGuid) {
        log.info(" 查询客户所有充电找中的IC卡列表customerGuid={}",customerGuid);

        // 查询所有充电中的记录
        DeviceUseDetailed param = new DeviceUseDetailed();
        param.setCustomerGuid(customerGuid);
        param.setOpenMeans(CustomerConstant.OpenMeansConstant.ICCARD.getType());
        param.setState(CustomerConstant.DeviceUsedRecordState.CHARGING.getState());
        List<DeviceUseDetailed> useDetaileds = deviceUseDetailedMapper.select(param);

        List<ChargingIcCardInfo> dataList = Lists.newArrayList();
        if (CollectionUtils.isEmpty(useDetaileds)) {
            return dataList;
        }

        for (DeviceUseDetailed useDetailed : useDetaileds) {
            ChargingIcCardInfo info = new ChargingIcCardInfo();
            info.setChargingGuid(useDetailed.getChargingGuid());
            info.setCardId(useDetailed.getOpenNo());
            dataList.add(info);
        }
        return dataList;
    }

}
